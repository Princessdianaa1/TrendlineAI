<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --border-color: #334155;
            --shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-secondary);
            padding: 20px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2em;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
        }

        .btn-success {
            background: var(--accent-success);
            color: white;
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
        }

        .card h3 {
            color: var(--text-muted);
            font-size: 0.9em;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card .amount {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .card.invested .amount {
            color: var(--accent-primary);
        }

        .card.current .amount {
            color: var(--accent-secondary);
        }

        .card.profit .amount {
            color: var(--accent-success);
        }

        .card.loss .amount {
            color: var(--accent-danger);
        }

        .percentage {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .percentage.positive {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-success);
        }

        .percentage.negative {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 28px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-color: transparent;
        }

        .tab:hover:not(.active) {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .card h2 {
            color: var(--text-primary);
            margin-bottom: 25px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg-tertiary);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        .asset-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Portfolio Tracker</h1>
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-primary" onclick="openAddModal()">+ Add Holding</button>
                <button class="btn btn-secondary" onclick="goHome()">‚Üê Back</button>
            </div>
        </div>

        <div class="summary-cards">
            <div class="card invested">
                <h3>Total Invested</h3>
                <div class="amount" id="totalInvested">‚Çπ0</div>
            </div>
            <div class="card current">
                <h3>Current Value</h3>
                <div class="amount" id="currentValue">‚Çπ0</div>
            </div>
            <div class="card" id="pnlCard">
                <h3>Total P&L</h3>
                <div class="amount" id="totalPnl">‚Çπ0</div>
                <span class="percentage" id="pnlPercentage">0%</span>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="filterAssets('all')">All Assets</div>
                <div class="tab" onclick="filterAssets('stock')">üìä Stocks</div>
                <div class="tab" onclick="filterAssets('crypto')">‚Çø Crypto</div>
                <div class="tab" onclick="filterAssets('mutual_fund')">üìà Mutual Funds</div>
                <div class="tab" onclick="filterAssets('gold')">ü™ô Gold</div>
            </div>

            <table id="holdingsTable">
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th>Type</th>
                        <th>Quantity</th>
                        <th>Avg Price</th>
                        <th>Current Price</th>
                        <th>Invested</th>
                        <th>Current Value</th>
                        <th>P&L</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="holdingsBody">
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div>No holdings yet. Add your first investment!</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="main-grid" style="margin-top: 30px;">
            <div class="card">
                <h2>üìä Asset Allocation</h2>
                <canvas id="assetChart"></canvas>
            </div>
            <div class="card">
                <h2>üìà P&L Distribution</h2>
                <canvas id="pnlChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Add Holding Modal -->
    <div id="addModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--bg-secondary); padding: 40px; border-radius: 24px; max-width: 600px; width: 90%; border: 1px solid var(--border-color); box-shadow: var(--shadow);">
            <h2 style="color: var(--text-primary); margin-bottom: 30px;">Add New Holding</h2>
            
            <form onsubmit="addHolding(event)">
                <div class="form-group">
                    <label>Asset Type</label>
                    <select id="assetType" required>
                        <option value="stock">Stock</option>
                        <option value="crypto">Cryptocurrency</option>
                        <option value="mutual_fund">Mutual Fund</option>
                        <option value="gold">Gold</option>
                        <option value="fd">Fixed Deposit</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Symbol/Code</label>
                        <input type="text" id="symbol" placeholder="e.g., RELIANCE, BTC" required>
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="assetName" placeholder="Full name" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="quantity" step="0.00000001" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Average Buy Price (‚Çπ)</label>
                        <input type="number" id="avgPrice" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Current Price (‚Çπ)</label>
                        <input type="number" id="currentPrice" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Exchange/Broker</label>
                        <input type="text" id="exchange" placeholder="NSE, BSE, Zerodha, etc.">
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <input type="text" id="notes" placeholder="Any additional notes">
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Holding</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080/api/portfolio';
        const userId = localStorage.getItem('userId');

        if (!userId) {
            alert('Please login first!');
            window.location.href = 'index.html';
        }

        let holdings = [];
        let assetChart, pnlChart;
        let currentFilter = 'all';

        function openAddModal() {
            document.getElementById('addModal').style.display = 'flex';
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.querySelector('form').reset();
        }

        async function addHolding(event) {
            event.preventDefault();

            const quantity = parseFloat(document.getElementById('quantity').value);
            const avgPrice = parseFloat(document.getElementById('avgPrice').value);
            const currentPrice = parseFloat(document.getElementById('currentPrice').value);
            
            const holding = {
                userId: parseInt(userId),
                assetType: document.getElementById('assetType').value,
                symbol: document.getElementById('symbol').value.toUpperCase(),
                name: document.getElementById('assetName').value,
                exchange: document.getElementById('exchange').value,
                quantity: quantity,
                averageBuyPrice: avgPrice,
                totalInvested: quantity * avgPrice,
                currentPrice: currentPrice,
                currentValue: quantity * currentPrice,
                unrealizedPnl: (quantity * currentPrice) - (quantity * avgPrice),
                unrealizedPnlPercentage: ((currentPrice - avgPrice) / avgPrice * 100),
                broker: document.getElementById('exchange').value,
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch(`${API_URL}/holding`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(holding)
                });

                if (response.ok) {
                    const saved = await response.json();
                    holdings.push(saved);
                    updateUI();
                    closeAddModal();
                    alert('‚úÖ Holding added successfully!');
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                // Fallback to localStorage
                holding.id = Date.now();
                holdings.push(holding);
                saveToLocalStorage();
                updateUI();
                closeAddModal();
                alert('‚úÖ Holding added (saved locally)');
            }
        }

        async function loadHoldings() {
            try {
                const response = await fetch(`${API_URL}/holdings/${userId}`);
                if (response.ok) {
                    holdings = await response.json();
                    updateUI();
                } else {
                    loadFromLocalStorage();
                }
            } catch (error) {
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            const stored = localStorage.getItem('portfolioHoldings');
            if (stored) {
                holdings = JSON.parse(stored);
                updateUI();
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('portfolioHoldings', JSON.stringify(holdings));
        }

        function filterAssets(type) {
            currentFilter = type;
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            updateTable();
        }

        function updateUI() {
            updateSummary();
            updateTable();
            updateCharts();
        }

        function updateSummary() {
            const totalInvested = holdings.reduce((sum, h) => sum + parseFloat(h.totalInvested), 0);
            const totalCurrent = holdings.reduce((sum, h) => sum + parseFloat(h.currentValue || h.totalInvested), 0);
            const totalPnl = totalCurrent - totalInvested;
            const pnlPercentage = totalInvested > 0 ? (totalPnl / totalInvested * 100) : 0;

            document.getElementById('totalInvested').textContent = '‚Çπ' + totalInvested.toLocaleString('en-IN', {maximumFractionDigits: 0});
            document.getElementById('currentValue').textContent = '‚Çπ' + totalCurrent.toLocaleString('en-IN', {maximumFractionDigits: 0});
            document.getElementById('totalPnl').textContent = '‚Çπ' + Math.abs(totalPnl).toLocaleString('en-IN', {maximumFractionDigits: 0});
            
            const pnlCard = document.getElementById('pnlCard');
            const pnlAmount = document.getElementById('totalPnl');
            const pnlPerc = document.getElementById('pnlPercentage');
            
            if (totalPnl >= 0) {
                pnlCard.className = 'card profit';
                pnlAmount.textContent = '+‚Çπ' + totalPnl.toLocaleString('en-IN', {maximumFractionDigits: 0});
                pnlPerc.className = 'percentage positive';
                pnlPerc.textContent = '+' + pnlPercentage.toFixed(2) + '%';
            } else {
                pnlCard.className = 'card loss';
                pnlAmount.textContent = '-‚Çπ' + Math.abs(totalPnl).toLocaleString('en-IN', {maximumFractionDigits: 0});
                pnlPerc.className = 'percentage negative';
                pnlPerc.textContent = pnlPercentage.toFixed(2) + '%';
            }
        }

        function updateTable() {
            const tbody = document.getElementById('holdingsBody');
            
            const filtered = currentFilter === 'all' 
                ? holdings 
                : holdings.filter(h => h.assetType === currentFilter);

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div>No ${currentFilter === 'all' ? '' : currentFilter} holdings yet.</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(h => {
                const pnl = parseFloat(h.unrealizedPnl || 0);
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                const pnlSign = pnl >= 0 ? '+' : '';
                
                const typeEmoji = {
                    'stock': 'üìä',
                    'crypto': '‚Çø',
                    'mutual_fund': 'üìà',
                    'gold': 'ü™ô',
                    'fd': 'üè¶'
                };

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <span class="asset-icon">${h.symbol.substring(0, 2)}</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${h.symbol}</div>
                                    <div style="font-size: 0.85em; color: var(--text-muted);">${h.name}</div>
                                </div>
                            </div>
                        </td>
                        <td>${typeEmoji[h.assetType] || 'üìä'} ${h.assetType.replace('_', ' ')}</td>
                        <td>${parseFloat(h.quantity).toFixed(4)}</td>
                        <td>‚Çπ${parseFloat(h.averageBuyPrice).toFixed(2)}</td>
                        <td>‚Çπ${parseFloat(h.currentPrice || h.averageBuyPrice).toFixed(2)}</td>
                        <td>‚Çπ${parseFloat(h.totalInvested).toLocaleString('en-IN', {maximumFractionDigits: 0})}</td>
                        <td>‚Çπ${parseFloat(h.currentValue || h.totalInvested).toLocaleString('en-IN', {maximumFractionDigits: 0})}</td>
                        <td>
                            <span class="percentage ${pnlClass}">
                                ${pnlSign}‚Çπ${Math.abs(pnl).toFixed(0)} (${pnlSign}${parseFloat(h.unrealizedPnlPercentage || 0).toFixed(2)}%)
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteHolding(${h.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateCharts() {
            updateAssetChart();
            updatePnlChart();
        }

        function updateAssetChart() {
            const assetTypes = {};
            holdings.forEach(h => {
                const type = h.assetType.replace('_', ' ');
                assetTypes[type] = (assetTypes[type] || 0) + parseFloat(h.totalInvested);
            });

            const ctx = document.getElementById('assetChart').getContext('2d');
            if (assetChart) assetChart.destroy();

            assetChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(assetTypes),
                    datasets: [{
                        data: Object.values(assetTypes),
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#cbd5e1', font: { size: 12 } }
                        }
                    }
                }
            });
        }

        function updatePnlChart() {
            const labels = holdings.map(h => h.symbol);
            const pnls = holdings.map(h => parseFloat(h.unrealizedPnl || 0));

            const ctx = document.getElementById('pnlChart').getContext('2d');
            if (pnlChart) pnlChart.destroy();

            pnlChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'P&L (‚Çπ)',
                        data: pnls,
                        backgroundColor: pnls.map(p => p >= 0 ? '#10b981' : '#ef4444')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#cbd5e1' },
                            grid: { color: '#334155' }
                        },
                        x: {
                            ticks: { color: '#cbd5e1' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function deleteHolding(id) {
            if (!confirm('Are you sure you want to delete this holding?')) return;

            try {
                const response = await fetch(`${API_URL}/holding/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    holdings = holdings.filter(h => h.id !== id);
                    updateUI();
                    alert('‚úÖ Holding deleted!');
                }
            } catch (error) {
                holdings = holdings.filter(h => h.id !== id);
                saveToLocalStorage();
                updateUI();
                alert('‚úÖ Holding deleted!');
            }
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        // Load holdings on page load
        loadHoldings();
    </script>
</body